##################################################################
# ###                                                        ### #
# ### EPICS Database for                                     ### #
# ###   ISEG ECH44A Crate Controller                         ### #
# ###                                                        ### #
# ### author: F.Feldbauer                                    ### #
# ###                                                        ### #
# ### Ref 1.0; 2014-05-22                                    ### #
# ###                                                        ### #
# ### macros: subsys      PANDA subsystem  (e.g. FEMC)       ### #
# ###         crate       sector of crate                    ### #
# ###         CAN_LINE    CAN line ID                        ### #
# ###         CRATE_ID    crate controller address           ### #
##################################################################

record{ longout, "PANDA:$(subsys):HVCRATE:$(crate):PowerOn" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${CRATE_ID}.PowerOn" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(crate):StatusLow" ) {
  field( DESC, "Lower 16 bit of module status register" )
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.Status" )
  field( NOBT, "16" )
  field( SHFT, "0" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(crate):StatusHigh" ) {
  field( DESC, "Upper 16 bit of module status register" )
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.Status" )
  field( NOBT, "16" )
  field( SHFT, "16" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(crate):EventStatusLow" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.EventStatus" )
  field( NOBT, "16" )
  field( SHFT, "0" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "PANDA:$(subsys):HVCRATE:$(crate):EventStatusHigh" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.EventStatus" )
  field( NOBT, "16" )
  field( SHFT, "16" )
  field( TSE,  "-2" )
}

record( ai, "PANDA:$(subsys):HVCRATE:$(crate):FanSpeed" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.FanSpeed" )
  field( TSE,  "-2" )
}

##############################
# ### Decoding of Status ### #
##############################
record( bi, "PANDA:$(subsys):HVCRATE:$(crate):LowP24Battery" ) {
  field( INP,  "PANDA:$(subsys):HVCRATE:$(crate):StatusLow.B0 CP" )
  field( ZNAM, "?" )
  field( ONAM, "?" )
  field( ZSV,  "NO_ALARM" )
  field( OSV,  "" )
}

  # Bit  0: Low +24 Battery
  # Bit  1: High +24 Battery
  # Bit  2: Low +5 Backplane
  # Bit  3: High +5 Backplane
  # Bit  4: Low +24 Backplane
  # Bit  5: High +24 Backplane
  # Bit  6: Service
  # Bit  7: High Temp
  # Bit  8: Low +5 CPU
  # Bit  9: High +5 CPU
  # Bit 10: Low +3.3 CPU
  # Bit 11: High +3.3 CPU
  # Bit 12: 
  # Bit 13: 
  # Bit 14: 
  # Bit 15: 
  # Bit 16: Power ON
  # Bit 17: Power Fail
  # Bit 18: HV On
  # Bit 19: Shut PC
  # Bit 20: 
  # Bit 21: 
  # Bit 22: 
  # Bit 23: 
  # Bit 24: 
  # Bit 25: 
  # Bit 26: 
  # Bit 27: 
  # Bit 28: 
  # Bit 29: 
  # Bit 30: 
  # Bit 31: 

  # Bit  0: Low +24 Battery
  # Bit  1: High +24 Battery
  # Bit  2: Low +5 Backplane
  # Bit  3: High +5 Backplane
  # Bit  4: Low +24 Backplane
  # Bit  5: High +24 Backplane
  # Bit  6: Service
  # Bit  7: High Temp
  # Bit  8: Low +5 CPU
  # Bit  9: High +5 CPU
  # Bit 10: Low +3.3 CPU
  # Bit 11: High +3.3 CPU
  # Bit 12: 
  # Bit 13: 
  # Bit 14: 
  # Bit 15: 
  # Bit 16: Power ON
  # Bit 17: Power Fail
  # Bit 18: HV On
  # Bit 19: Shut PC
  # Bit 20: 
  # Bit 21: 
  # Bit 22: 
  # Bit 23: 
  # Bit 24: 
  # Bit 25: 
  # Bit 26: 
  # Bit 27: 
  # Bit 28: 
  # Bit 29: 
  # Bit 30: 
  # Bit 31: 
