##################################################################
# ###                                                        ### #
# ### EPICS Database for                                     ### #
# ###   iseg HAL                                             ### #
# ###                                                        ### #
# ### author: F.Feldbauer                                    ### #
# ###                                                        ### #
# ### Ref 1.0; 2015-06-02                                    ### #
# ###                                                        ### #
# ### macros: CRATE_SN    serial number of crate controller  ### #
# ###         CAN_LINE    CAN line ID                        ### #
# ###         CRATE_ID    crate address                      ### #
# ###         MODULE_ID   module address                     ### #
# ###         CHANNEL_ID  HV channel address                 ### #
##################################################################

#############################
# ### Crate item values ### #
#############################

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusLow" ) {
  field( DESC, "Lower 16 bit of module status register" )
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.Status" )
  field( NOBT, "16" )
  field( SHFT, "0" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusHigh" ) {
  field( DESC, "Upper 16 bit of module status register" )
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.Status" )
  field( NOBT, "16" )
  field( SHFT, "16" )  ## shift the value by 16 bits to the right
  field( TSE,  "-2" )
}

# Alternative way to read out the status:
# In this case only the calc record needs to be triggered

#record( longin, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusRead__" ) {
#  field( DTYP, "isegHAL" )
#  field( INP,  "@${CAN_LINE}.${CRATE_ID}.Status" )
#}
#record( calc, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusSplit__" ) {
#  ## PP = Passive Process: Force the other record to process before sending the value
#  field( INPA, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusRead PP" )
#
#  field( INPB, "0x0000ffff" )
#  field( INPC, "0xffff0000" )
#
#  ## First, set field D to ( field A bitwise AND field B ),
#  ## then set field VAL to ( field A bitwise AND field C ) right shifted by 16 bit
#  field( CALC, "d:=(A&B); (A&C)>>16" ) 
#}
#record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusLow" ) {
#  field( DTYP, "Soft Channel" )
#  field( INP,  "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusSplit__.D CP" )
#}
#record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusHigh" ) {
#  field( DTYP, "Soft Channel" )
#  field( INP,  "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:StatusSplit__.VAL CP" )
#}

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:EventStatusLow" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.EventStatus" )
  field( NOBT, "16" )
  field( SHFT, "0" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:EventStatusHigh" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.EventStatus" )
  field( NOBT, "16" )
  field( SHFT, "16" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:FanSpeed" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.FanSpeed" )
  field( TSE,  "-2" )
}

record( bo, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:PowerOn" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${CRATE_ID}.PowerOn" )
  field( TSE,  "-2" )
  field( ZNAM, "Off" )
  field( ONAM, "On" )
}

record( stringin, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:FirmwareName" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${CRATE_ID}.FirmwareName" )
  field( TSE,  "-2" )
}

##############################
# ### Module item values ### #
##############################

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:Status" ) {
  field( DESC, "Lower 16 bit of module status register" )
  field( DTYP, "isegHAL" )
  field( DISV, "0" )  ## Disable Value (if value linked by SDIS == DISV record is disabled)
  field( SDIS, "ISEG:${CRATE_SN}:${CAN_LINE}:${CRATE_ID}:PowerOn.VAL NPP MS" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.Status" )
  field( FLNK, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:EventStatus" ) ## Build read out chains
  field( TSE,  "-2" )
}

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:EventStatus" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.EventStatus" )
  field( FLNK, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:Temperature" )
  field( TSE,  "-2" )
}

record( ao, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:VoltageRampSpeed" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.VoltageRampSpeed" )
  field( TSE,  "-2" )
}

record( ao, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:CurrentRampSpeed" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.CurrentRampSpeed" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:VoltageLimit" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.VoltageLimit" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:CurrentLimit" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.CurrentLimit" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:Temperature" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.Temperature" )
  field( TSE,  "-2" )
}

record( stringin, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:FirmwareName" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.FirmwareName" )
  field( TSE,  "-2" )
}

###############################
# ### Channel item values ### #
###############################

record( ao, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:VoltageSet" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.VoltageSet" )
  field( TSE,  "-2" )
}

record( ao, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:CurrentSet" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.CurrentSet" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:VoltageMeasure" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.VoltageMeasure" )
  field( FLNK, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:CurrentMeasure" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:CurrentMeasure" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.CurrentMeasure" )
  field( FLNK, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:Status" )
  field( TSE,  "-2" )
}

record( ao, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:VoltageBounds" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.VoltageBounds" )
  field( TSE,  "-2" )
}

record( ao, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:CurrentBounds" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.CurrentBounds" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:VoltageNominal" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.VoltageNominal" )
  field( TSE,  "-2" )
}

record( ai, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:CurrentNominal" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.CurrentNominal" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:Status" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.Status" )
  field( FLNK, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:EventStatus" )
  field( TSE,  "-2" )
}

record( bo, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:Control:3" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.Control:3" )
  field( ZNAM, "Channel off" )
  field( ONAM, "Channel on" )
  field( TSE,  "-2" )
}

record( bo, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:Control:5" ) {
  field( DTYP, "isegHAL" )
  field( OUT,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.Control:5" )
  field( ZNAM, "" )
  field( ONAM, "Set EMCY" )
  field( TSE,  "-2" )
}

record( mbbiDirect, "ISEG:${CRATE_SN}:${CAN_LINE}:${MODULE_ID}:${CHANNEL_ID}:EventStatus" ) {
  field( DTYP, "isegHAL" )
  field( INP,  "@${CAN_LINE}.${MODULE_ID}.${CHANNEL_ID}.EventStatus" )
  field( TSE,  "-2" )
}

